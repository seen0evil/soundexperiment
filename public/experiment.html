<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Structured Peak Timing Experiment</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"></script>
  <style>
    :root {
      --bg:#060606;
      --panel:#121212;
      --panel-border:rgba(255,255,255,0.08);
      --text:#f5f5f5;
      --muted:#a0a0a0;
      --accent:#d9d9d9;
      --danger:#c4c4c4;
      --success:#dedede;
      --overlay-bg:linear-gradient(180deg, #151515, #0b0b0b);
    }
    * { box-sizing: border-box; }
    body { margin:0; font:16px/1.5 "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background:var(--bg); color:var(--text); }
    .layout { min-height:100vh; display:flex; flex-direction:column; }
    header { padding:20px 24px; border-bottom:1px solid rgba(255,255,255,0.06); display:flex; flex-direction:column; align-items:center; gap:12px; }
    header h1 { margin:0; font-size:22px; font-weight:700; letter-spacing:0.3px; }
    .header-bar { width:100%; max-width:1080px; margin:0 auto; display:flex; align-items:center; justify-content:center; gap:18px; flex-wrap:wrap; text-align:center; }
    .header-progress { display:flex; align-items:center; justify-content:center; gap:12px; font-size:16px; color:var(--muted); text-transform:uppercase; letter-spacing:0.6px; }
    .header-progress strong { color:var(--text); font-weight:700; font-size:18px; letter-spacing:0; text-transform:none; }
    .header-progress .divider { opacity:0.5; }
    .header-progress.is-idle .divider { display:none; }
    .header-progress.is-idle .trial-count { display:none; }
    .header-progress .trial-count { display:inline-flex; align-items:center; gap:6px; padding:6px 14px; border-radius:999px; background:rgba(255,255,255,0.1); color:var(--text); font-size:15px; text-transform:none; letter-spacing:0.2px; }
    .header-progress .trial-count strong { font-size:18px; }
    .header-progress .trial-count[data-state="pending"] { background:rgba(255,255,255,0.16); color:var(--text); }
    .header-progress .trial-count[data-state="ok"] { background:rgba(255,255,255,0.14); color:var(--success); }
    .header-progress .trial-count[data-state="idle"] { background:rgba(255,255,255,0.1); color:var(--muted); }
    main { flex:1; display:flex; flex-direction:column; padding:0; min-height:0; }
    .canvas-shell { flex:1; position:relative; width:100%; display:flex; align-items:stretch; justify-content:center; padding:0; min-height:0; }
    #sketch-holder { flex:1; width:100%; height:100%; display:flex; align-items:center; justify-content:center; }
    #sketch-holder canvas { display:block; max-width:100%; max-height:100%; height:auto !important; border-radius:0; }
    .score-overlay { position:absolute; top:24px; left:50%; transform:translateX(-50%); display:flex; flex-direction:column; align-items:center; gap:4px; pointer-events:none; text-transform:uppercase; letter-spacing:1px; color:var(--muted); z-index:2; }
    .score-overlay .score-label { font-size:12px; opacity:0.7; }
    .score-overlay .score-value { font-size:32px; font-weight:700; color:var(--text); text-transform:none; letter-spacing:0.4px; }
    .overlay { position:fixed; inset:0; background:rgba(0,0,0,0.9); display:flex; align-items:center; justify-content:center; padding:0; z-index:10; transition:opacity 0.3s ease; }
    .overlay.hidden { opacity:0; pointer-events:none; }
    .overlay-panel { width:100%; height:100%; background:var(--overlay-bg); border:none; border-radius:0; padding:clamp(32px, 6vw, 72px); display:flex; flex-direction:column; justify-content:center; align-items:center; gap:24px; text-align:center; }
    .overlay-panel h2 { margin:0; font-size:clamp(26px, 4vw, 36px); font-weight:700; letter-spacing:0.4px; }
    .overlay-panel p { margin:0 0 12px; font-size:18px; color:var(--muted); }
    .overlay-panel p:last-child { margin-bottom:0; }
    .overlay-actions { display:flex; flex-wrap:wrap; gap:16px; justify-content:center; }
    .overlay-panel button { background:var(--accent); border:none; color:#111; font-weight:600; padding:12px 22px; border-radius:999px; cursor:pointer; font-size:16px; transition:transform 0.15s ease, box-shadow 0.15s ease; }
    .overlay-panel button:hover { transform:translateY(-1px); box-shadow:0 18px 36px rgba(0,0,0,0.35); }
    .overlay-panel button.disabled { opacity:0.5; cursor:default; transform:none; box-shadow:none; }
    .overlay-panel button.secondary { background:transparent; color:var(--text); border:1px solid rgba(255,255,255,0.2); box-shadow:none; }
    .overlay-panel button.secondary:hover { box-shadow:0 18px 36px rgba(0,0,0,0.35); }
    #overlayAdvance { background:transparent; border:none; color:var(--muted); font-weight:500; letter-spacing:0.6px; text-transform:uppercase; pointer-events:none; cursor:default; padding:0; transition:transform 0.15s ease, box-shadow 0.15s ease; }
    #overlayAdvance[data-mode="button"] { background:var(--accent); color:#111; pointer-events:auto; cursor:pointer; padding:12px 22px; border-radius:999px; letter-spacing:0; text-transform:none; font-weight:600; }
    #overlayAdvance[data-mode="button"]:not(.disabled):hover { transform:translateY(-1px); box-shadow:0 18px 36px rgba(0,0,0,0.35); }
    #overlayAdvance[data-mode="button"].disabled { opacity:0.5; cursor:default; transform:none; box-shadow:none; }
    #overlayAdvance:focus { outline:none; }
    .participant-form { display:flex; flex-direction:column; gap:8px; margin-top:4px; }
    .participant-form label { font-size:14px; color:var(--muted); }
    .participant-form input { border-radius:10px; border:1px solid rgba(255,255,255,0.2); padding:10px; font-size:16px; background:#1a1a1a; color:var(--text); }
    .participant-form input:focus { outline:2px solid rgba(255,255,255,0.3); outline-offset:2px; }
    .participant-form .error { font-size:13px; color:var(--danger); display:none; }
    .participant-form[data-error="true"] .error { display:block; }
    .end-summary { background:rgba(255,255,255,0.04); border-radius:14px; padding:16px; }
    .end-summary dl { margin:0; display:grid; grid-template-columns:auto 1fr; gap:10px 18px; }
    .end-summary dt { font-weight:600; color:var(--text); }
    .end-summary dd { margin:0; color:var(--muted); }
    #controlStubs { display:none; }
    body.cursor-hidden, body.cursor-hidden * { cursor:none !important; }
    @media (max-width:640px) {
      header { padding:16px; }
      .header-progress { font-size:14px; gap:8px; }
      .score-overlay { top:16px; }
      .overlay-panel { padding:48px 24px; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <header>
      <div class="header-bar">
        <h1>Peak Timing Study</h1>
        <div class="header-progress is-idle" aria-live="polite">
          <span class="block-label" id="hudBlockLabel">Waiting to begin…</span>
          <span class="divider">•</span>
          <span class="trial-count" id="hudTrialCount" data-state="idle" aria-label="Trial progress"><strong id="hudTrialDone">0</strong>/<span id="hudTrialTotal">0</span></span>
        </div>
      </div>
    </header>
    <main>
      <section class="canvas-shell">
        <div class="score-overlay" aria-live="polite">
          <div class="score-label">Total score</div>
          <div class="score-value" id="hudOverallScore">0</div>
        </div>
        <div id="sketch-holder"></div>
      </section>
    </main>
    <div class="overlay hidden" id="experimentOverlay" role="dialog" aria-modal="true">
      <div class="overlay-panel">
        <h2 id="overlayTitle">Welcome</h2>
        <div id="overlayBody"></div>
        <div class="participant-form" id="participantForm">
          <label for="participantIdInput">Prolific ID</label>
          <input id="participantIdInput" type="text" maxlength="80" autocomplete="off" />
          <div class="error" id="participantError">Please enter your ID before continuing.</div>
        </div>
        <div class="overlay-actions">
          <button id="overlayAdvance" type="button" tabindex="-1">Press space to continue</button>
          <button id="overlaySurvey" type="button" hidden disabled>Open survey</button>
        </div>
      </div>
    </div>
  </div>

  <div id="controlStubs">
    <div id="lastScore">—</div>
    <div id="judgement">Press to start</div>
    <input id="speed" type="range" min="0.4" max="3.0" step="0.02" value="1.40" />
    <div id="speedVal">1.40</div>
    <input id="sharp" type="range" min="1" max="6" step="0.1" value="2" />
    <div id="sharpVal">2.0×</div>
    <input id="amp" type="range" min="60" max="220" step="2" value="140" />
    <div id="ampVal">140</div>
    <div id="log"></div>
    <div id="attempts">0</div>
    <div id="avg">—</div>
    <button id="reset" type="button"></button>
    <button id="modeBall" type="button"></button>
    <button id="modeBar" type="button"></button>
    <button id="modeTarget" type="button"></button>
    <input id="pointsMax" type="range" min="10" max="100" step="5" value="100" />
    <div id="pointsMaxVal">100</div>
    <input id="rewardGamma" type="range" min="0.5" max="6" step="0.1" value="2" />
    <div id="rewardGammaVal">2.0</div>
    <input id="playerSpeed" type="range" min="0.5" max="3" step="0.1" value="1" />
    <div id="playerSpeedVal">1.00 s</div>
    <input id="targetMin" type="range" min="0.6" max="0.9" step="0.01" value="0.60" />
    <div id="targetMinVal">0.60</div>
    <input id="targetMax" type="range" min="0.6" max="0.9" step="0.01" value="0.90" />
    <div id="targetMaxVal">0.90</div>
    <input id="fps" type="range" min="10" max="240" step="1" value="60" />
    <div id="fpsVal">60</div>
    <input id="poll" type="range" min="5" max="1000" step="5" value="250" />
    <div id="pollVal">250</div>
    <div id="clock"></div>
    <div id="ev2fr"></div>
    <div id="po2fr"></div>
    <div id="ev2po"></div>
    <div id="pollLog"></div>
    <select id="audioMode">
      <option value="off">No sound</option>
      <option value="immediate">Immediate at keypress</option>
      <option value="delay">After delay (align with score)</option>
    </select>
    <input id="audioDelay" type="range" min="0" max="500" step="5" value="0" />
    <div id="audioDelayVal">0</div>
    <input id="audioDur" type="range" min="5" max="2000" step="5" value="100" />
    <div id="audioDurVal">100</div>
    <input id="audioVol" type="range" min="0" max="1" step="0.01" value="1" />
    <div id="audioVolVal">1.00</div>
    <input id="audioFile" type="file" />
    <input id="audioUrl" type="url" />
    <button id="audioLoadUrl" type="button"></button>
    <div id="audioStatus"></div>
  </div>

  <script src="targetMode.js"></script>
  <script src="peakTimingGame.js"></script>
  <script src="experimentFlow.js"></script>
</body>
</html>
